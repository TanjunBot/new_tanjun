name: Notify discord on closed issues
on:
  issues:
    types: [closed]
jobs:
  notify_discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@main
      - name: Extract event information
        id: event_info
        run: |
          echo "title=[Fertiggestellt]: ${{ github.event.issue.title }}" >> $GITHUB_ENV
          description_raw="${{ replace(github.event.issue.body, '`', '\\`') }}"
          description=$(echo "$description_raw" | jq -sRr @json)
          echo "description=$description" >> $GITHUB_ENV
          echo "author_name=${{ github.event.issue.user.login }}" >> $GITHUB_ENV
          echo "author_url=https://github.com/${{ github.event.issue.user.login }}" >> $GITHUB_ENV
          echo "author_profileicon=https://avatars.githubusercontent.com/${{ github.event.issue.user.login }}" >> $GITHUB_ENV
          echo "timestamp=${{ github.event.issue.closed_at }}" >> $GITHUB_ENV
          echo "footer_text=Issue #${{ github.event.issue.number }}" >> $GITHUB_ENV
          echo "color=5763719" >> $GITHUB_ENV
          echo "username=Tanjun Issue Tracker" >> $GITHUB_ENV
      - name: Post update on Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          payload=$(cat <<EOF
          {
            "content": null,
            "embeds": [
              {
                "title": "${{ env.title }}",
                "description": ${description},  # Use the variable directly here, jq already JSON-escaped
                "color": ${{ env.color }},
                "author": {
                  "name": "${{ env.author_name }}",
                  "url": "${{ env.author_url }}",
                  "icon_url": "${{ env.author_profileicon }}"
                },
                "footer": {
                  "text": "${{ env.footer_text }}"
                },
                "timestamp": "${{ env.timestamp }}"
              }
            ],
            "username": "${{ env.username }}",
            "attachments": []
          }
          EOF
          )
          curl -X POST -H 'Content-Type: application/json' -d "$payload" $DISCORD_WEBHOOK_URL
